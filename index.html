<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Listar Produtos (Básico)</title>
</head>
<body>
  <h1>Listar Produtos Omie</h1>
  <button id="btnBuscar">Buscar Lista de Produtos</button>
  <div id="resultado"></div>

  <script>
    const btnBuscar = document.getElementById("btnBuscar");
    const resultadoEl = document.getElementById("resultado");

    btnBuscar.addEventListener("click", async () => {
      resultadoEl.textContent = "Carregando...";
      try {
        const resp = await fetch("/.netlify/functions/listarProdutos");
        if (!resp.ok) {
          throw new Error("Erro ao chamar a função serverless: " + resp.statusText);
        }
        
        const data = await resp.json();
        
        // Se houve falha no retorno, data pode ter { error: "...", faultstring: "..." }
        if (data.error) {
          resultadoEl.textContent = "Erro: " + data.error;
          return;
        }
        if (data.faultstring) {
          // Se a Omie retornou algo como "Fault"
          resultadoEl.textContent = "Erro Omie: " + data.faultstring;
          return;
        }

        // data deve ter { pagina, total_de_paginas, registros, produto_servico_cadastro: [...], etc }
        // Se for modo resumido, seria data.produto_servico_resumido
        // Mas aqui, ListarProdutos retorna "produto_servico_cadastro" em "produto_servico_listfull_response"
        
        const produtos = data.produto_servico_cadastro || [];
        if (produtos.length === 0) {
          resultadoEl.textContent = "Nenhum produto encontrado (página 1).";
          return;
        }

        // Monta uma lista simples exibindo 'codigo' e 'descricao'
        let html = `<p>Página: ${data.pagina} de ${data.total_de_paginas} (Total de ${data.total_de_registros} registros)</p>`;
        html += "<ul>";
        produtos.forEach((prod) => {
          const codigo = prod.codigo || "";
          const descricao = prod.descricao || "";
          html += `<li>${codigo} - ${descricao}</li>`;
        });
        html += "</ul>";
        
        resultadoEl.innerHTML = html;

      } catch (err) {
        resultadoEl.textContent = "Ocorreu um erro: " + err.message;
      }
    });
  </script>
</body>
</html>
